import{u as y,R as d,j as t,b as j,t as _}from"./entry-index-B-fzmtso.js";import{u as S,a as n}from"./chunk-api-iyIgA2Lz.js";import{d as f,S as g,b as w,g as C,a as N,c as b}from"./chunk-SettingCard-Jn5uUOv3.js";import{S as k}from"./chunk-SettingCardMultiInput-C6J2QTKQ.js";import{f as I}from"./chunk-unitHelper-BjgrQHpY.js";import{p as z}from"./chunk-code-CMZ6HDeg.js";import{o as h}from"./chunk-button-DEhGMKH8.js";import{p as v}from"./chunk-flex-MGzrVjdG.js";import{u as T}from"./chunk-text-field-BEd1A3G3.js";import{p as P}from"./chunk-base-button-DH9OSHVU.js";import"./chunk-react-vendor-Csw2ODfV.js";import"./chunk-text-area-BDJYKPt5.js";import"./chunk-dropdown-menu-CbliYoMA.js";import"./chunk-icons-VdLkFx5D.js";import"./chunk-require-react-element-DVojHXYL.js";import"./chunk-index-BBO7VtY0.js";import"./chunk-index-D_W452Xx.js";import"./chunk-icon-button-Bgu4ejrN.js";import"./chunk-switch-DMZS-wzt.js";import"./chunk-index-B-NU4fG6.js";import"./chunk-proxy-Dyr7ArBS.js";import"./chunk-chevron-down-DWbbmXVQ.js";import"./chunk-index-Bm_BBTjY.js";import"./chunk-internal-Be4ivmVq.js";function ie(){const{t:e}=y(),{settings:r,loading:p,error:o}=S(),[m,u]=d.useState(null),[s,l]=d.useState(null);return d.useEffect(()=>{const i=parseInt(r.ping_record_preserve_time||"30",10),a=parseInt(r.record_preserve_time||"30",10);if(isNaN(i)||isNaN(a)){l("0");return}else l(x(i,a))},[r.ping_record_preserve_time,r.record_preserve_time]),p?t.jsx(j,{text:"creeper?"}):o?t.jsx(P,{color:"red",children:o}):t.jsxs(t.Fragment,{children:[t.jsx(f,{children:e("settings.general.auto_discovery")}),t.jsx(R,{settings:r}),t.jsx("label",{className:"text-xl font-bold",children:e("settings.geoip.title")}),t.jsx(g,{title:e("settings.geoip.enable_title"),description:e("settings.geoip.enable_description"),defaultChecked:r.geo_ip_enabled,onChange:async i=>{await n({geo_ip_enabled:i},e)}}),t.jsx(w,{title:e("settings.geoip.provider_title"),description:e("settings.geoip.provider_description"),defaultValue:r.geo_ip_provider,options:[{value:"empty",label:e("common.none")},{value:"mmdb",label:"MaxMind"},{value:"ip-api",label:"ip-api.com"},{value:"geojs",label:"geojs.io"},{value:"ipinfo",label:"ipinfo.io"}],OnSave:async i=>{await n({geo_ip_provider:i},e)}}),t.jsx(C,{title:e("settings.geoip.update_title","更新 GeoIP 数据库"),onClick:async()=>{const a=await(await fetch("/api/admin/update/mmdb",{method:"POST"})).json();a.status==="success"?_.success(e("settings.geoip.update_success","GeoIP 数据库更新成功")):_.error(a.message||e("settings.geoip.update_error","更新 GeoIP 数据库失败"))},children:e("common.update","更新")}),t.jsx(N,{title:e("settings.geoip.test_title"),description:e("settings.geoip.test_description"),children:t.jsxs(v,{className:"w-full gap-2",direction:"column",children:[t.jsx(T,{placeholder:"1.1.1.1 or 2606:4700:4700::1111"}),t.jsx("div",{children:t.jsx(h,{variant:"solid",onClick:async()=>{const i=document.querySelector("input[placeholder]").value,c=await(await fetch(`/api/admin/test/geoip?ip=${i}`)).json();u(JSON.stringify(c.data,null,2)||"无结果")},children:e("settings.geoip.test_button","测试")})})," ",t.jsx(v,{className:"w-full",children:m&&t.jsx(z,{className:"w-full whitespace-pre-wrap text-sm p-3 rounded-md overflow-auto max-h-96",style:{display:"block"},children:m})})]})}),t.jsx("label",{className:"text-xl font-bold",children:e("settings.record.title")}),t.jsx(g,{title:e("settings.record.enabled"),description:e("settings.record.enabled_description"),defaultChecked:r.record_enabled,onChange:async i=>{await n({record_enabled:i},e)}}),t.jsx(k,{defaultOpen:!0,title:e("settings.record.record_preserve_time"),description:e("settings.record.record_preserve_time_description"),items:[{tag:"record_preserve_time",label:e("settings.record.record_preserve_time_label"),type:"short",placeholder:"30",defaultValue:r.record_preserve_time||"30",number:!0},{tag:"ping_record_preserve_time",label:e("settings.record.ping_record_preserve_time"),type:"short",placeholder:"30",defaultValue:r.ping_record_preserve_time||"30",number:!0}],onSave:async i=>{const a=parseInt(i.record_preserve_time,10),c=parseInt(i.ping_record_preserve_time,10);if(isNaN(a)||isNaN(c)){_.error(e("settings.record.invalid_preserve_time"));return}await n({record_preserve_time:a,ping_record_preserve_time:c},e)},onChange:i=>{const a=parseInt(i.record_preserve_time,10),c=parseInt(i.ping_record_preserve_time,10);if(isNaN(a)||isNaN(c)){l("0");return}l(x(c,a))},children:t.jsx("label",{className:"text-sm text-muted-foreground",children:e("settings.record.expected_usage",{space:s})})}),t.jsx(f,{children:e("settings.nezha.title")}),t.jsx("label",{className:"text-sm text-muted-foreground -mt-4",children:e("settings.nezha.description")}),t.jsx(g,{title:e("settings.nezha.enabled"),description:e("settings.nezha.enabled_description"),defaultChecked:r.nezha_compat_enabled,onChange:async i=>{await n({nezha_compat_enabled:i},e)}}),t.jsx(b,{title:e("settings.nezha.listen"),description:e("settings.nezha.listen_description"),defaultValue:r.nezha_compat_listen||"",placeholder:"0.0.0.0:5555",OnSave:async i=>{await n({nezha_compat_listen:i},e)}})]})}function x(e,r){let p=0,o=0;return p=e*3600,r<=4?o=r*1*1024*60:(o=4*1*1024*60,o+=(r-4)*4*1024),I(p+o)}const R=({settings:e})=>{const{t:r}=y(),[p,o]=d.useState((e==null?void 0:e.auto_discovery_key)||""),m=()=>{const s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";let l="";for(let i=0;i<24;i++)l+=s.charAt(Math.floor(Math.random()*s.length));return l},u=()=>{const s=m();o(s)};return d.useEffect(()=>{e!=null&&e.auto_discovery_key&&o(e.auto_discovery_key)},[e==null?void 0:e.auto_discovery_key]),t.jsx(b,{title:r("settings.general.auto_discovery_key"),description:r("settings.general.auto_discovery_key_description"),value:p,onChange:s=>o(s.target.value),OnSave:async s=>{if(!s){await n({auto_discovery_key:""},r);return}if(s.length<12){_.error(r("settings.api.key_length_error"));return}await n({auto_discovery_key:s},r)},children:t.jsxs("div",{className:"flex flex-row gap-2 justify-start items-center",children:[t.jsx(h,{variant:"soft",color:"green",onClick:u,children:r("common.generate")}),t.jsx(h,{variant:"soft",color:"mint",onClick:()=>{window.open("https://komari-document.pages.dev/install/agent-ad.html","_blank")},children:r("common.help")})]})})};export{ie as default};
