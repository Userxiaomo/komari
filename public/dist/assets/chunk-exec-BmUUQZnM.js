import{c as h,j as e,u as L,r as c,b as H,t as i}from"./entry-index-B-fzmtso.js";import{N as q,u as A}from"./chunk-NodeDetailsContext-C405bEFp.js";import{N as J}from"./chunk-NodeSelector-BYu2gOLI.js";import{a as M}from"./chunk-SettingCard-Jn5uUOv3.js";import{T as B,C as G}from"./chunk-terminal-BnC5kMgn.js";import{p as d}from"./chunk-base-button-DH9OSHVU.js";import{o as K}from"./chunk-separator-BTxVbICm.js";import{o as j}from"./chunk-card-BGBx-kb8.js";import{p as a}from"./chunk-flex-MGzrVjdG.js";import{u as Q,c as U}from"./chunk-text-field-BEd1A3G3.js";import{o as y}from"./chunk-button-DEhGMKH8.js";import{e as V}from"./chunk-badge-NlYxK9Bs.js";import"./chunk-react-vendor-Csw2ODfV.js";import"./chunk-table-CFAkpkHt.js";import"./chunk-utils-bRKmu4jq.js";import"./chunk-search-SRY80dSo.js";import"./chunk-checkbox-DtfZQmnL.js";import"./chunk-internal-Be4ivmVq.js";import"./chunk-icons-VdLkFx5D.js";import"./chunk-require-react-element-DVojHXYL.js";import"./chunk-index-B-NU4fG6.js";import"./chunk-text-area-BDJYKPt5.js";import"./chunk-dropdown-menu-CbliYoMA.js";import"./chunk-index-BBO7VtY0.js";import"./chunk-index-D_W452Xx.js";import"./chunk-icon-button-Bgu4ejrN.js";import"./chunk-switch-DMZS-wzt.js";import"./chunk-proxy-Dyr7ArBS.js";import"./chunk-chevron-down-DWbbmXVQ.js";import"./chunk-index-Bm_BBTjY.js";/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const W=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]],X=h("circle-alert",W);/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Y=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]],Z=h("circle-check",Y);/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ee=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["polyline",{points:"12 6 12 12 16 14",key:"68esgv"}]],se=h("clock",ee);/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const te=[["polygon",{points:"6 3 20 12 6 21 6 3",key:"1oa8hb"}]],re=h("play",te),Fe=()=>e.jsx(q,{children:e.jsx(ne,{})}),ne=()=>{const{t:n}=L(),{nodeDetail:N,isLoading:S,error:k}=A(),[u,E]=c.useState(""),[m,P]=c.useState([]),[w,v]=c.useState(!1),[b,f]=c.useState([]),[_,g]=c.useState(null),[$,C]=c.useState(!1),x=c.useRef(null),p=c.useRef(null),l=()=>{x.current&&(clearInterval(x.current),x.current=null),p.current&&(clearTimeout(p.current),p.current=null),C(!1)};if(c.useEffect(()=>()=>{l()},[]),S)return e.jsx(H,{});if(k)return e.jsx("div",{className:"text-red-500",children:k});const T=async s=>{try{const t=await fetch(`/api/admin/task/${s}/result`);if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const r=await t.json();let o;r.success&&r.results?o=r.results:r.status==="success"&&r.data&&(o=r.data),o&&(f(o),o.every(O=>O.finished_at!==null)&&(l(),i.success(n("exec.allCompleted","所有任务执行完成"))))}catch(t){console.error("轮询任务结果失败:",t),l()}},z=s=>{l(),C(!0),T(s),x.current=setInterval(()=>{T(s)},2e3),p.current=setTimeout(()=>{f(t=>t.map(r=>r.finished_at===null?{...r,finished_at:new Date().toISOString(),exit_code:-1,result:"执行超时"}:r)),l(),i.warning(n("exec.pollingTimeout","任务执行超时"))},6e4)},R=async()=>{var s;if(!u.trim()){i.error(n("exec.errors.emptyCommand"));return}if(m.length===0){i.error(n("exec.errors.noNodes"));return}l(),v(!0),f([]),g(null);try{const t=await fetch("/api/admin/task/exec",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({command:u.trim(),clients:m})});if(!t.ok){const o=await t.json().catch(()=>({}));throw new Error(o.message||`HTTP error! status: ${t.status}`)}const r=await t.json();if(r.success&&r.task_id)g(r.task_id),i.success(n("exec.taskStarted")),z(r.task_id);else if(r.status==="success"&&((s=r.data)!=null&&s.task_id))g(r.data.task_id),i.success(n("exec.taskStarted")),z(r.data.task_id);else throw new Error(r.message)}catch(t){const r=t instanceof Error?t.message:"未知错误";i.error(r)}finally{v(!1)}},I=s=>{navigator.clipboard.writeText(s),i.success(n("common.success"))},D=()=>m.map(s=>{const t=N.find(r=>r.uuid===s);return t?t.name:s}).join(", "),F=s=>s.finished_at===null?{status:"running",color:"blue",text:n("exec.status.running")}:s.result==="执行超时"?{status:"timeout",color:"orange",text:n("exec.status.timeout","超时")}:s.exit_code===0?{status:"success",color:"green",text:n("common.success")}:{status:"failed",color:"red",text:n("common.error")};return e.jsxs("div",{className:"p-4 flex flex-col gap-3",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:n("exec.title")}),e.jsx(d,{size:"2",color:"gray",className:"mt-1",children:n("exec.description")})]}),e.jsx(K,{size:"4"}),e.jsx(j,{className:"p-6",children:e.jsxs(a,{direction:"column",gap:"4",children:[e.jsx("label",{className:"text-xl font-bold",children:n("exec.command")}),e.jsx(Q,{value:u,onChange:s=>E(s.target.value),placeholder:n("exec.commandPlaceholder"),size:"3",children:e.jsx(U,{children:e.jsx(B,{size:16})})}),e.jsxs("div",{children:[e.jsx(M,{title:n("exec.selectNodes"),defaultOpen:!0,children:e.jsx(J,{value:m,onChange:P,className:"min-h-[200px]"})}),m.length>0&&e.jsxs(d,{size:"2",color:"gray",className:"mt-2",children:[n("exec.selectedNodes","已选择节点"),": ",D()]})]}),e.jsx(a,{justify:"end",gap:"2",children:e.jsx(y,{onClick:R,disabled:w||!u.trim()||m.length===0,children:w?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-2 border-current border-t-transparent"}),n("exec.executing")]}):e.jsxs(e.Fragment,{children:[e.jsx(re,{size:16}),n("exec.execute")]})})})]})}),b.length>0&&e.jsx(j,{className:"p-6",children:e.jsxs(a,{direction:"column",gap:"4",children:[e.jsxs(a,{justify:"between",align:"center",children:[e.jsx(d,{size:"4",weight:"medium",children:n("exec.results","执行结果")}),_&&e.jsxs(d,{size:"2",color:"gray",children:["Task ID: ",_]})]}),e.jsx("div",{className:"space-y-4",children:b.map(s=>{var r;const t=F(s);return e.jsx(j,{className:"p-4",children:e.jsxs(a,{direction:"column",gap:"3",children:[e.jsx("label",{className:"text-xl font-medium",children:((r=N.find(o=>o.uuid===s.client))==null?void 0:r.name)||s.client}),e.jsxs(a,{justify:"between",align:"center",children:[e.jsxs(a,{align:"center",gap:"2",children:[e.jsx(d,{weight:"medium",children:s.client_info.name}),e.jsx(V,{color:t.color,variant:"soft",children:t.status==="running"?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-3 w-3 border-2 border-current border-t-transparent"}),t.text]}):t.status==="success"?e.jsxs(e.Fragment,{children:[e.jsx(Z,{size:12}),t.text]}):t.status==="timeout"?e.jsxs(e.Fragment,{children:[e.jsx(se,{size:12}),t.text]}):e.jsxs(e.Fragment,{children:[e.jsx(X,{size:12}),t.text]})}),s.exit_code!==null&&e.jsxs(d,{size:"1",color:"gray",children:["Exit Code: ",s.exit_code]})]}),s.result&&e.jsx(y,{variant:"ghost",size:"1",onClick:()=>I(s.result),children:e.jsx(G,{size:14})})]}),s.result&&e.jsx("div",{className:"bg-[var(--gray-2)] rounded-md p-3 font-mono text-sm overflow-x-auto",children:e.jsx("pre",{className:"whitespace-pre-wrap",children:s.result})})]})},s.client)})}),$&&e.jsxs(a,{align:"center",justify:"between",className:"text-sm text-gray-500",children:[e.jsxs(a,{align:"center",gap:"2",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-2 border-current border-t-transparent"}),e.jsx(d,{size:"2",color:"gray",children:"正在获取最新执行状态..."})]}),e.jsx(y,{variant:"soft",size:"1",onClick:l,children:"停止轮询"})]})]})})]})};export{Fe as default};
