import{r as w,S as U,y as q,c as C,j as e,u as F,R as h,b as B,t as n}from"./entry-index-B-fzmtso.js";import{A as G,u as E}from"./chunk-AccountContext-Du9FCxFP.js";import{e as M,t as I,v as V,r as H,p}from"./chunk-flex-MGzrVjdG.js";import{e as R}from"./chunk-badge-NlYxK9Bs.js";import{o as d}from"./chunk-button-DEhGMKH8.js";import{s as T,n as A,p as L,g as $,m as D,D as J}from"./chunk-dialog-DmkLuhHc.js";import{u as v}from"./chunk-text-field-BEd1A3G3.js";import"./chunk-react-vendor-Csw2ODfV.js";import"./chunk-base-button-DH9OSHVU.js";import"./chunk-heading-CKQb6e5J.js";import"./chunk-require-react-element-DVojHXYL.js";import"./chunk-internal-Be4ivmVq.js";const Q=parseFloat(w.version)>=19||"",Z={loading:{type:"boolean",default:!0},...I,...M},P=w.forwardRef((s,a)=>{const{children:c,className:f,loading:u,...x}=V(s,Z,H);if(!u)return c;const g=w.isValidElement(c)?U:"span";return w.createElement(g,{ref:a,"aria-hidden":!0,className:q("rt-Skeleton",f),"data-inline-skeleton":w.isValidElement(c)?void 0:!0,tabIndex:-1,inert:Q,...x},c)});P.displayName="Skeleton";/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const K=[["path",{d:"M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4",key:"tonef"}],["path",{d:"M9 18c-4.51 2-5-2-7-2",key:"9comsn"}]],W=C("github",K);/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const X=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20",key:"13o1zl"}],["path",{d:"M2 12h20",key:"9i4pu4"}]],Y=C("globe",X);/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ee=[["path",{d:"M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2",key:"975kel"}],["circle",{cx:"12",cy:"7",r:"4",key:"17ys0d"}]],O=C("user",ee),xe=()=>e.jsx(G,{children:e.jsx(se,{})}),se=()=>{const{t:s}=F(),{account:a,loading:c,error:f,refresh:u}=E(),[x,g]=h.useState(!1),[m,j]=h.useState(!1);if(c)return e.jsx(B,{});if(f)return e.jsx("div",{children:f.message});function S(t){t.preventDefault(),g(!0),fetch("/api/admin/update/user",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({uuid:a==null?void 0:a.uuid,username:t.currentTarget.username.value})}).then(r=>{if(!r.ok)throw new Error("Failed to update username");return r.json()}).then(()=>{n.success(s("common.updated_successfully"))}).catch(r=>{n.error(r.message)}).finally(()=>{g(!1)})}function _(t){t.preventDefault();const r=t.currentTarget,i=r.password.value,N=r.password_repeat.value;if(!i||!N){n.error(s("account.password_empty_error"));return}if(i!==N){n.error(s("account.password_mismatch_error"));return}if(i.length<8){n.error(s("account.password_too_short_error"));return}if(!/(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/.test(i)){n.error(s("account.password_strength_error"));return}j(!0),fetch("/api/admin/update/user",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({uuid:a==null?void 0:a.uuid,password:i})}).then(async b=>{if(!b.ok){const z=await b.json();throw new Error(z.message||"Failed to update password")}return b.json()}).then(()=>{n.success(s("common.updated_successfully")),setTimeout(()=>{window.location.href="/"},2e3)}).catch(b=>{n.error(b.message)}).finally(()=>{j(!1)})}function y(){if(!(a!=null&&a.sso_id))return null;const[t,r]=a.sso_id.split("_",2);return{platform:t||"",uniqueId:r||"",isBound:!!a.sso_id}}function k(t){switch(t.toLowerCase()){case"github":return e.jsx(W,{className:"size-5"});case"google":return e.jsx(Y,{className:"size-5"});default:return e.jsx(O,{className:"size-5"})}}function o(t){switch(t.toLowerCase()){case"github":return"GitHub";case"google":return"Google";case"gitlab":return"GitLab";case"discord":return"Discord";default:return t.charAt(0).toUpperCase()+t.slice(1)}}const l=async()=>{try{const t=y();if(t!=null&&t.isBound){const r=await fetch("/api/admin/oauth2/unbind",{method:"POST"});if(r.ok)n.success(s("account_settings.unbind_sso_success",{provider:o(t.platform)})),u();else{const i=await r.json();n.error(s("account_settings.unbind_sso_failed",{provider:o(t.platform),error:i.message||s("account_settings.unknown_error")}))}}else window.location.href="/api/admin/oauth2/bind"}catch(t){console.error("处理SSO认证失败:",t),n.error(s("account_settings.sso_auth_failed"))}};return e.jsx(p,{gap:"4",direction:"column",align:"start",children:e.jsxs(p,{gap:"4",direction:"row",className:"p-4",wrap:"wrap",children:[e.jsxs(p,{gap:"2",direction:"column",className:"w-full",children:[e.jsx("label",{className:"text-2xl font-bold",children:s("account.title")}),e.jsx("label",{className:"text-lg",children:s("account.greeting",{username:a==null?void 0:a.username})}),e.jsxs("form",{className:"flex gap-2 flex-col",onSubmit:S,children:[e.jsx("label",{className:"font-bold",htmlFor:"username",children:s("account.change_username_title")}),e.jsx(v,{className:"max-w-128",id:"username",name:"username",defaultValue:a==null?void 0:a.username}),e.jsx("div",{children:e.jsx(d,{disabled:x,type:"submit",children:s("account.change_username_button")})})]}),e.jsxs("form",{onSubmit:_,className:"flex flex-col gap-2",children:[e.jsx("label",{className:"font-bold",htmlFor:"old_password",children:s("account.change_password_title")}),e.jsx("label",{htmlFor:"password",children:s("account.new_password")}),e.jsx(v,{className:"max-w-128",id:"password",name:"password",type:"password"}),e.jsx("label",{htmlFor:"password_repeat",children:s("account.new_password_repeat")}),e.jsx(v,{className:"max-w-128",id:"password_repeat",name:"password_repeat",type:"password"}),e.jsx("div",{children:e.jsx(d,{disabled:m,type:"submit",children:s("account.change_password_button")})})]})]}),e.jsxs(p,{direction:"column",className:"gap-2",children:[e.jsx("label",{className:"font-bold text-2xl",children:"2FA"}),a!=null&&a["2fa_enabled"]?e.jsx(ae,{}):e.jsx(te,{}),e.jsx("label",{className:"font-bold text-2xl mt-2",children:s("settings.sso.title")}),e.jsx("div",{className:"mb-8 flex flex-col gap-4 ",children:(()=>{const t=y(),r=(t==null?void 0:t.platform)||"",i=o(r),N=k(r);return e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"text-xl font-semibold flex items-center gap-2",children:[t!=null&&t.isBound?N:e.jsx(O,{className:"size-5"}),t!=null&&t.isBound?`${i}账户`:s("account_settings.sso_account")]}),e.jsx("div",{className:"p-4 bg-[var(--accent-2)] rounded-lg",children:e.jsx("p",{children:t!=null&&t.isBound?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(R,{color:"green",children:s("account_settings.sso_bound")}),i," ID: ",t.uniqueId]}):e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(R,{color:"gray",children:s("account_settings.sso_unbound")}),s("account_settings.sso_not_bound")]})})}),e.jsx("div",{children:t!=null&&t.isBound?e.jsxs(T,{children:[e.jsx(A,{children:e.jsx(d,{children:s("account_settings.unbind_sso",{provider:i})})}),e.jsxs(L,{children:[e.jsx($,{children:s("account_settings.confirm_unbind")}),e.jsx(D,{children:s("account_settings.unbind_sso_warning",{provider:i})}),e.jsxs(p,{gap:"2",justify:"end",className:"mt-4",children:[e.jsx(J,{children:e.jsx(d,{variant:"soft",children:s("account_settings.cancel")})}),e.jsx(d,{color:"red",onClick:l,children:s("account_settings.confirm_unbind")})]})]})]}):e.jsxs(d,{onClick:l,children:[e.jsx(O,{className:"size-4"}),s("account_settings.bind_sso")]})})]})})()}),e.jsx(p,{gap:"4",align:"center",justify:"start",children:e.jsx("label",{className:"text-muted-foreground text-sm",children:s("account_settings.looking_for_backup")})})]})]})})},te=()=>{const{t:s}=F(),{refresh:a}=E(),[c,f]=h.useState(!1),[u,x]=h.useState(!1),[g,m]=h.useState(!0),[j,S]=h.useState(null),[_,y]=h.useState("");h.useEffect(()=>{u&&(m(!0),fetch("/api/admin/2fa/generate").then(o=>{if(!o.ok)throw new Error(s("account.qr_fetch_error"));return o.blob()}).then(o=>{const l=URL.createObjectURL(o);S(l)}).catch(o=>n.error(o.message)).finally(()=>m(!1)))},[u]);const k=o=>{if(o.preventDefault(),!_){n.error(s("account.otp_empty_error"));return}f(!0),fetch(`/api/admin/2fa/enable?code=${encodeURIComponent(_)}`,{method:"POST"}).then(async l=>{if(!l.ok){const t=await l.json();throw new Error(t.message||`Failed to enable 2FA (${l.status})`)}return l.json()}).then(()=>{n.success(s("common.updated_successfully")),x(!1),a()}).catch(l=>n.error(l.message)).finally(()=>f(!1))};return e.jsxs(p,{direction:"column",gap:"2",children:[e.jsx("label",{className:"text-lg font-bold",children:s("account.2fa_disabled")}),e.jsxs(T,{open:u,onOpenChange:x,children:[e.jsx(A,{children:e.jsx("div",{children:e.jsx(d,{className:"w-full",children:s("account.enable_2fa")})})}),e.jsxs(L,{children:[e.jsx($,{children:s("account.enable_2fa")}),e.jsxs(p,{direction:"column",gap:"2",children:[e.jsx("label",{children:s("account.2fa_qr_code_hint")}),e.jsx("div",{className:"flex justify-center",children:g?e.jsx(P,{width:"200px",height:"200px"}):e.jsx("img",{src:j,alt:"2FA QR Code",width:200,height:200})}),e.jsx("label",{children:s("account.2fa_otp_input_prompt")}),e.jsxs("form",{className:"flex flex-col gap-2",onSubmit:k,children:[e.jsx(v,{type:"number",name:"code",placeholder:"000000",value:_,onChange:o=>y(o.target.value)}),e.jsx(d,{disabled:c,type:"submit",children:s("account.enable_2fa")})]})]})]})]})]})},ae=()=>{const{t:s}=F(),[a,c]=h.useState(!1),[f,u]=h.useState(!1),{refresh:x}=E(),g=()=>{u(!0),fetch("/api/admin/2fa/disable",{method:"POST"}).then(async m=>{if(!m.ok){const j=await m.json();throw new Error(j.message||"Failed to disable 2FA")}return m.json()}).then(()=>{n.success(s("common.updated_successfully")),c(!1),x()}).catch(m=>{n.error(m.message)}).finally(()=>{u(!1)})};return e.jsxs(p,{direction:"column",gap:"2",children:[e.jsx("label",{children:s("account.2fa_enabled")}),e.jsx("div",{children:e.jsxs(T,{open:a,onOpenChange:c,children:[e.jsx(A,{children:e.jsx(d,{className:"ml-2",color:"red",children:s("account.disable_2fa")})}),e.jsxs(L,{children:[e.jsx($,{children:s("account.disable_2fa")}),e.jsx(D,{children:s("account.disable_2fa_confirmation")}),e.jsxs(p,{gap:"2",justify:"end",className:"mt-4",children:[e.jsx(d,{variant:"soft",onClick:()=>c(!1),children:s("common.cancel")}),e.jsx(d,{disabled:f,color:"red",onClick:g,children:s("common.confirm")})]})]})]})})]})};export{xe as default};
