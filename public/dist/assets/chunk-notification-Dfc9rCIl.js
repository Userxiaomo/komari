import{u as L,R as o,j as s,b as y,t as d,L as M}from"./entry-index-B-fzmtso.js";import{u as E,a as p}from"./chunk-api-iyIgA2Lz.js";import{d as P,S as T,e as N,b as V,g as k}from"./chunk-SettingCard-Jn5uUOv3.js";import{r as R}from"./chunk-renderProviders-DX-XzUL2.js";import{S as D}from"./chunk-square-arrow-out-up-right-C2tWSi9-.js";import{p as _}from"./chunk-base-button-DH9OSHVU.js";import"./chunk-react-vendor-Csw2ODfV.js";import"./chunk-text-area-BDJYKPt5.js";import"./chunk-flex-MGzrVjdG.js";import"./chunk-button-DEhGMKH8.js";import"./chunk-dropdown-menu-CbliYoMA.js";import"./chunk-icons-VdLkFx5D.js";import"./chunk-require-react-element-DVojHXYL.js";import"./chunk-index-BBO7VtY0.js";import"./chunk-index-D_W452Xx.js";import"./chunk-icon-button-Bgu4ejrN.js";import"./chunk-switch-DMZS-wzt.js";import"./chunk-index-B-NU4fG6.js";import"./chunk-text-field-BEd1A3G3.js";import"./chunk-internal-Be4ivmVq.js";import"./chunk-proxy-Dyr7ArBS.js";import"./chunk-chevron-down-DWbbmXVQ.js";import"./chunk-index-Bm_BBTjY.js";import"./chunk-SettingCardMultiInput-C6J2QTKQ.js";const at=()=>{const{t:e}=L(),{settings:r,loading:g,error:u}=E(),[b,v]=o.useState({}),[h,w]=o.useState([]),[n,S]=o.useState(""),[C,f]=o.useState({}),[x,a]=o.useState(!1),[l,m]=o.useState("");o.useEffect(()=>{g||(a(!0),fetch("/api/admin/settings/message-sender").then(t=>t.json()).then(t=>{if(t.status==="success"&&t.data){v(t.data);const i=Object.keys(t.data);w(i);const c=r.notification_method&&i.includes(r.notification_method)?r.notification_method:"";S(c)}else m(t.message||"获取消息通道信息失败")}).catch(()=>m("获取消息通道信息失败")).finally(()=>a(!1)))},[g,r.notification_method]),o.useEffect(()=>{n&&(a(!0),fetch(`/api/admin/settings/message-sender?provider=${n}`).then(t=>t.json()).then(t=>{if(t.status==="success"&&t.data)try{f(JSON.parse(t.data.addition||"{}"))}catch{f({})}else m(t.message||"获取设置失败")}).catch(()=>m("获取设置失败")).finally(()=>a(!1)))},[n]);const O=async t=>{a(!0),m("");const i={name:n,addition:JSON.stringify(t)};try{const j=await(await fetch("/api/admin/settings/message-sender",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)})).json();if(j.status!=="success")throw new Error(j.message||e("common.error"));f(t),d.success(e("common.success"))}catch(c){d.error(c instanceof Error?c.message:String(c))}a(!1)};return g||!x&&h.length===0&&!l?s.jsx(y,{}):u?s.jsx(_,{color:"red",children:u}):l?s.jsx(_,{color:"red",children:l}):s.jsxs(s.Fragment,{children:[s.jsx(P,{children:e("settings.notification.title")}),s.jsx(T,{title:e("settings.notification.enable"),description:e("settings.notification.enable_description"),defaultChecked:r.notification_enabled,onChange:async t=>{await p({notification_enabled:t},e)}}),s.jsx(N,{title:e("settings.notification.template"),description:e("settings.notification.template_description"),defaultValue:r.notification_template,OnSave:async t=>{await p({notification_template:t},e)}}),s.jsx(V,{title:e("settings.notification.method"),description:e("settings.notification.method_description"),options:h.map(t=>({value:t,label:t})),value:n,OnSave:async t=>{t!==n&&(await p({notification_method:t},e),S(t))}}),x?s.jsx(y,{}):R({currentProvider:n,providerDefs:b,providerValues:C,translationPrefix:`settings.notification.${n}`,title:e("settings.notification.provider_fields"),description:e("settings.notification.provider_fields_description"),setProviderValues:f,handleSave:O,t:e}),s.jsx(k,{title:e("settings.notification.test_title"),description:e("settings.notification.test_description"),onClick:async()=>{try{const t=await fetch("/api/admin/test/sendMessage",{method:"POST"});let i;try{i=await t.json()}catch{d.error(e("common.error"));return}if(i&&i.message&&i.code!==200){d.error(i.message);return}d.success(e("common.success"))}catch(t){d.error(e("common.error")+": "+(t instanceof Error?t.message:String(t)))}},children:"GO"}),s.jsxs("label",{className:"text-muted-foreground text-sm flex flex-row items-center gap-1",children:[e("settings.notification.moved"),s.jsx(M,{to:"/admin/notification/general",children:s.jsx(D,{size:16})})]})]})};export{at as default};
