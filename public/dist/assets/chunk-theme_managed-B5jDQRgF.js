import{f as q,u as F,r as i,j as t,b as H,t as $}from"./entry-index-B-fzmtso.js";import{c as L,b as M,S as R}from"./chunk-SettingCard-Jn5uUOv3.js";import{p as y}from"./chunk-flex-MGzrVjdG.js";import{r as N}from"./chunk-heading-CKQb6e5J.js";import{o as P}from"./chunk-button-DEhGMKH8.js";import{n as v,u as S}from"./chunk-callout-Dor7Er5s.js";import{o as V}from"./chunk-separator-BTxVbICm.js";import"./chunk-react-vendor-Csw2ODfV.js";import"./chunk-text-area-BDJYKPt5.js";import"./chunk-base-button-DH9OSHVU.js";import"./chunk-dropdown-menu-CbliYoMA.js";import"./chunk-icons-VdLkFx5D.js";import"./chunk-require-react-element-DVojHXYL.js";import"./chunk-index-BBO7VtY0.js";import"./chunk-index-D_W452Xx.js";import"./chunk-icon-button-Bgu4ejrN.js";import"./chunk-switch-DMZS-wzt.js";import"./chunk-index-B-NU4fG6.js";import"./chunk-text-field-BEd1A3G3.js";import"./chunk-internal-Be4ivmVq.js";import"./chunk-proxy-Dyr7ArBS.js";import"./chunk-chevron-down-DWbbmXVQ.js";import"./chunk-index-Bm_BBTjY.js";const de=()=>{const{publicInfo:l,refresh:z}=q(),o=l==null?void 0:l.theme,u=(l==null?void 0:l.theme_settings)||{},{t:c}=F(),[j,f]=i.useState(!1),[w,C]=i.useState(!1),[m,k]=i.useState([]),[h,p]=i.useState({}),[x,b]=i.useState(null),[B,O]=i.useState(!0);i.useEffect(()=>{async function e(){var n;if(!o||o==="default"){k([]),p({});return}f(!0),b(null);try{const s=await fetch(`/themes/${o}/komari-theme.json`,{cache:"no-cache"});if(!s.ok)throw new Error(`HTTP ${s.status}`);const a=await s.json();if(!((n=a.configuration)!=null&&n.data)){k([]),p({});return}const r=a.configuration.data;k(r);const _={};r.forEach(d=>{d.type!=="title"&&d.key&&(_[d.key]=u&&u[d.key]!==void 0?u[d.key]:d.default)}),p(_)}catch(s){b(s.message||"加载主题配置失败")}finally{f(!1),O(!1)}}e()},[o,u]);const g=(e,n)=>{p(s=>({...s,[e]:n}))},T=i.useMemo(()=>{const e={};return m.forEach(n=>{if(n.type==="title"||!n.key)return;const s=h[n.key];s!==void 0?e[n.key]=s:n.default!==void 0?e[n.key]=n.default:e[n.key]=""}),e},[m,h]),E=async()=>{if(o){console.log("保存前的 values:",h),console.log("保存前的 payload:",T),C(!0);try{const e=await fetch(`/api/admin/theme/settings?theme=${encodeURIComponent(o)}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(T)});if(!e.ok){const n=await e.json().catch(()=>({message:"unknown"}));throw new Error(n.message||`HTTP ${e.status}`)}$.success("保存成功"),z()}catch(e){$.error(`保存失败: ${e.message||e}`)}finally{C(!1)}}};return t.jsxs(y,{direction:"column",gap:"4",className:"p-2 md:p-4",children:[t.jsxs(y,{justify:"between",align:"center",children:[t.jsx(N,{size:"4",children:o?c("theme.manage_with_name",{name:o}):c("theme.manage")}),m.length>0&&t.jsx(P,{onClick:E,disabled:w,children:c("common.save")})]}),x&&t.jsx(v,{color:"red",children:t.jsx(S,{children:x})}),j&&B&&t.jsx(H,{}),!j&&o==="default"&&t.jsx(v,{children:t.jsx(S,{children:c("theme.default_no_config")})}),!j&&!x&&m.length===0&&o!=="default"&&t.jsx(v,{children:t.jsx(S,{children:c("theme.no_config")})}),t.jsx(V,{size:"4"}),t.jsx(y,{direction:"column",gap:"3",children:m.map((e,n)=>{if(e.type==="title")return t.jsx(N,{size:"3",className:"mt-4",children:e.name||"标题"},n);if(!e.key)return null;const s=h[e.key];switch(e.type){case"switch":return t.jsx(R,{title:e.name,description:e.help,defaultChecked:!!s,onChange:a=>g(e.key,a)},e.key);case"select":{const a=(e.options||"").split(",").map(r=>r.trim()).filter(Boolean).map(r=>({value:r}));return t.jsx(M,{title:e.name,description:e.help,value:s,options:a,OnSave:r=>g(e.key,r),label:s||"选择"},e.key)}case"number":return t.jsx(L,{title:e.name,description:e.help,type:"number",showSaveButton:!1,value:s!==void 0?String(s):"",onChange:a=>g(e.key,a.target.value===""?void 0:Number(a.target.value))},e.key);case"string":default:return t.jsx(L,{title:e.name,description:e.help,value:s!==void 0?String(s):"",required:e.required,showSaveButton:!1,onChange:a=>g(e.key,a.target.value)},e.key)}})}),m.length>0&&t.jsx(y,{children:t.jsx(P,{onClick:E,disabled:w,children:c("common.save")})})]})};export{de as default};
