import{u as C,R as n,j as s,b,t as E}from"./entry-index-B-fzmtso.js";import{d as v,S as w,b as L,c as T}from"./chunk-SettingCard-Jn5uUOv3.js";import{u as P,a as l}from"./chunk-api-iyIgA2Lz.js";import{r as N}from"./chunk-renderProviders-DX-XzUL2.js";import{p as k}from"./chunk-base-button-DH9OSHVU.js";import{o as R}from"./chunk-button-DEhGMKH8.js";import"./chunk-react-vendor-Csw2ODfV.js";import"./chunk-text-area-BDJYKPt5.js";import"./chunk-flex-MGzrVjdG.js";import"./chunk-dropdown-menu-CbliYoMA.js";import"./chunk-icons-VdLkFx5D.js";import"./chunk-require-react-element-DVojHXYL.js";import"./chunk-index-BBO7VtY0.js";import"./chunk-index-D_W452Xx.js";import"./chunk-icon-button-Bgu4ejrN.js";import"./chunk-switch-DMZS-wzt.js";import"./chunk-index-B-NU4fG6.js";import"./chunk-text-field-BEd1A3G3.js";import"./chunk-internal-Be4ivmVq.js";import"./chunk-proxy-Dyr7ArBS.js";import"./chunk-chevron-down-DWbbmXVQ.js";import"./chunk-index-Bm_BBTjY.js";import"./chunk-SettingCardMultiInput-C6J2QTKQ.js";function ot(){const{t:e}=C(),{settings:i,loading:p,error:c}=P(),[h,m]=n.useState({}),[r,u]=n.useState([]),[o,S]=n.useState(""),[O,f]=n.useState({}),[y,d]=n.useState(!1),[_,a]=n.useState("");n.useEffect(()=>{p||(d(!0),fetch("/api/admin/settings/oidc").then(t=>t.json()).then(t=>{if(t.status==="success"&&t.data){m(t.data);const g=Object.keys(t.data);u(g);const j=i.o_auth_provider&&g.includes(i.o_auth_provider)?i.o_auth_provider:"";S(j)}else a(t.message||"获取登录接口信息失败")}).catch(()=>a("获取登录接口信息失败")).finally(()=>d(!1)))},[p,i.o_auth_provider]),n.useEffect(()=>{o&&(d(!0),fetch(`/api/admin/settings/oidc?provider=${o}`).then(t=>t.json()).then(t=>{if(t.status==="success"&&t.data)try{f(JSON.parse(t.data.addition||"{}"))}catch{f({})}else a(t.message||"获取设置失败")}).catch(()=>a("获取设置失败")).finally(()=>d(!1)))},[o]);const A=async t=>{d(!0),a("");const g={name:o,addition:JSON.stringify(t)};try{const x=await(await fetch("/api/admin/settings/oidc",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(g)})).json();x.status!=="success"?a(x.message||"保存失败"):f(t)}catch{a("保存失败")}d(!1)};return p||!y&&r.length===0&&!_?s.jsx(b,{}):c?s.jsx(k,{color:"red",children:c}):_?s.jsx(k,{color:"red",children:_}):s.jsxs(s.Fragment,{children:[s.jsx(v,{children:e("settings.sign_on.title")}),s.jsx(w,{title:e("settings.sign_on.disable_password","禁止密码登录"),defaultChecked:i.disable_password_login,onChange:async t=>{await l({disable_password_login:t},e)}}),s.jsx(v,{children:e("settings.sso.title")}),s.jsx(w,{title:e("settings.sso.enable","启用单点登录"),defaultChecked:i.o_auth_enabled,description:e("settings.sso.enable_description","启用单点登录功能"),onChange:async t=>{await l({o_auth_enabled:t},e)}}),s.jsx(L,{title:String(e("settings.sso.provider")),description:String(e("settings.sso.provider_description")),options:r.map(t=>({value:t,label:t})),value:o,OnSave:async t=>{t!==o&&(await l({o_auth_provider:t},e),S(t))}}),y?s.jsx(b,{}):N({currentProvider:o,providerDefs:h,providerValues:O,translationPrefix:"settings.sso."+o,title:e("settings.sso.provider_fields"),description:e("settings.sso.provider_fields_description"),footer:e("settings.sso.callback_url_tips",{url:`${window.location.origin}/api/oauth_callback`}),setProviderValues:f,handleSave:A,t:e}),s.jsx(v,{children:"API"}),s.jsx(V,{})]})}const V=()=>{const{settings:e}=P(),{t:i}=C(),[p,c]=n.useState((e==null?void 0:e.api_key)||""),h=()=>{const r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";let u="komari-";for(let o=0;o<32;o++)u+=r.charAt(Math.floor(Math.random()*r.length));return u},m=()=>{const r=h();c(r)};return n.useEffect(()=>{e!=null&&e.api_key&&c(e.api_key)},[e==null?void 0:e.api_key]),s.jsx(T,{title:i("settings.api.title"),description:i("settings.api.description"),value:p,onChange:r=>c(r.target.value),OnSave:async r=>{if(!r){await l({api_key:""},i);return}if(r.length<12){E.error(i("settings.api.key_length_error"));return}await l({api_key:r},i)},children:s.jsx("div",{className:"flex flex-row gap-2 justify-start items-center",children:s.jsx(R,{variant:"soft",color:"green",onClick:m,children:i("common.generate")})})})};export{ot as default};
