import{c as V,u as fe,r as i,z as ge,f as xe,j as e,b as je,t as p}from"./entry-index-B-fzmtso.js";import{u as ye}from"./chunk-api-iyIgA2Lz.js";import{a as we,U as ve}from"./chunk-UploadDialog-Dc9afAsf.js";import{S as D}from"./chunk-settings-CuxDDIla.js";import{S as _e}from"./chunk-square-arrow-out-up-right-C2tWSi9-.js";import{p as d}from"./chunk-base-button-DH9OSHVU.js";import{p as f}from"./chunk-box-3B0sA5_Q.js";import{p as l}from"./chunk-flex-MGzrVjdG.js";import{o as u}from"./chunk-button-DEhGMKH8.js";import{o as ke}from"./chunk-grid-BFXhBsSL.js";import{o as Ne}from"./chunk-card-BGBx-kb8.js";import{e as be}from"./chunk-badge-NlYxK9Bs.js";import{o as ze}from"./chunk-icon-button-Bgu4ejrN.js";import{s as O,p as L,g as $,D as P,m as K}from"./chunk-dialog-DmkLuhHc.js";import"./chunk-react-vendor-Csw2ODfV.js";import"./chunk-heading-CKQb6e5J.js";import"./chunk-require-react-element-DVojHXYL.js";/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Se=[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2",key:"1m3agn"}],["circle",{cx:"9",cy:"9",r:"2",key:"af1f0g"}],["path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21",key:"1xmnt7"}]],A=V("image",Se);/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ue=[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]],Q=V("refresh-cw",Ue),Xe=()=>{const{t:s}=fe(),[j,S]=i.useState([]),[Y,Z]=i.useState(!0),[ee,_]=i.useState(!1),[te,y]=i.useState(0),[H,k]=i.useState(null),[M,q]=i.useState(null),[R,se]=i.useState(null),[ae,U]=i.useState(!1),[a,J]=i.useState(null),[re,g]=i.useState(!1),[ne,N]=i.useState(!1),[w,W]=i.useState(null),[oe,b]=i.useState(!1),[B,F]=i.useState(null),[X,I]=i.useState(!1),{settings:T,loading:E,refetch:G}=ye(),m=T==null?void 0:T.theme,ie=ge(),{publicInfo:x}=xe(),[le,v]=i.useState(!1);i.useEffect(()=>{let t=!1;async function r(){const n=m||(x==null?void 0:x.theme);if(!n||n==="default"){v(!1);return}try{const h=await fetch(`/themes/${n}/komari-theme.json`,{cache:"no-cache"});if(!h.ok){v(!1);return}const o=await h.json().catch(()=>null);!t&&o&&o.configuration&&Array.isArray(o.configuration.data)&&o.configuration.data.length>0?v(!0):t||v(!1)}catch{t||v(!1)}}return r(),()=>{t=!0}},[m,x==null?void 0:x.theme]);const ce=Y||E||!m,z=async()=>{try{const t=await fetch("/api/admin/theme/list");if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const n=(await t.json()).data||[];n.some(c=>c.short==="default")||n.unshift({id:"default",name:s("theme.default_theme"),short:"default",description:s("theme.default_description"),author:"Akizon77",version:"1.0.0",preview:"/assets/edit_117847723_p0.png",active:m==="default",createdAt:new Date().toISOString()});const o=n.map(c=>({...c,active:c.short===m}));S(o)}catch(t){se(t instanceof Error?t.message:"Failed to fetch themes")}finally{Z(!1)}},de=async t=>{if(!t.name.endsWith(".zip")){p.error(s("theme.invalid_file_type"));return}_(!0),y(0);const r=new FormData;return r.append("file",t),new Promise((n,h)=>{const o=new XMLHttpRequest;k(o),o.upload.addEventListener("progress",c=>{if(c.lengthComputable){const ue=c.loaded/c.total*100;y(Math.round(ue))}}),o.addEventListener("load",async()=>{if(o.status>=200&&o.status<300)try{JSON.parse(o.responseText),p.success(s("theme.upload_success")),U(!1),y(0),await z(),n()}catch(c){p.error(s("theme.upload_failed")+": Parse error"),h(c)}else try{const c=JSON.parse(o.responseText);throw new Error(c.message||"Upload failed")}catch(c){p.error(s("theme.upload_failed")+": "+(c instanceof Error?c.message:"Unknown error")),h(c)}_(!1),k(null)}),o.addEventListener("error",()=>{p.error(s("theme.upload_failed")+": Network error"),_(!1),y(0),k(null),h(new Error("Network error"))}),o.addEventListener("abort",()=>{p.error(s("theme.upload_failed")+": Upload cancelled"),_(!1),y(0),k(null),h(new Error("Upload cancelled"))}),o.open("PUT","/api/admin/theme/upload"),o.send(r)})},he=()=>{H&&H.abort()},C=async t=>{try{q(t);const r=await fetch(`/api/admin/theme/set?theme=${t}`);if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);await G(),S(h=>h.map(o=>({...o,active:o.short===t})));const n=j.find(h=>h.short===t);console.log(n),n&&n.configuration&&n.configuration.data&&window.location.reload(),p.success(s("theme.set_success"))}catch(r){p.error(s("theme.set_failed")+": "+(r instanceof Error?r.message:"Unknown error"))}finally{q(null)}},pe=async t=>{try{I(!0);const n=await fetch("/api/admin/theme/update",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({short:t,useOriginalUrl:!0})});if(!n.ok){const h=await n.json();throw new Error(h.message||"Update failed")}await z(),b(!1),g(!1),p.success(s("theme.update_success"))}catch(r){p.error(s("theme.update_failed")+": "+(r instanceof Error?r.message:"Unknown error"))}finally{I(!1)}},me=async t=>{try{t===m&&(await C("default"),await G());const r=await fetch("/api/admin/theme/delete",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({short:t})});if(!r.ok){const n=await r.json();throw new Error(n.message||"Delete failed")}await z(),N(!1),g(!1),p.success(s("theme.delete_success"))}catch(r){p.error(s("theme.delete_failed")+": "+(r instanceof Error?r.message:"Unknown error"))}};return i.useEffect(()=>{z()},[m]),i.useEffect(()=>{!E&&j.length>0&&S(t=>t.map(r=>({...r,active:r.short===m})))},[m,E,j.length]),ce?e.jsx(je,{}):R?e.jsx(d,{color:"red",children:R}):e.jsxs(f,{className:"p-6 space-y-6",children:[e.jsxs(l,{justify:"between",align:"center",gap:"3",wrap:"wrap",children:[e.jsx(d,{size:"6",weight:"bold",children:s("theme.title")}),e.jsxs(l,{gap:"2",children:[le&&e.jsxs(u,{variant:"soft",className:"gap-2",onClick:()=>ie("/admin/theme_managed"),children:[e.jsx(D,{size:16}),`${m}设置`]}),e.jsxs(u,{onClick:()=>U(!0),className:"gap-2",children:[e.jsx(we,{size:16}),s("theme.upload")]})]})]}),j.length===0?e.jsxs(f,{className:"text-center py-12",children:[e.jsx(A,{size:64,className:"mx-auto text-gray-400 mb-4"}),e.jsx(d,{size:"4",color:"gray",className:"mb-2",children:s("theme.no_themes")}),e.jsx(d,{size:"2",color:"gray",children:s("theme.upload_first_theme")})]}):e.jsx(ke,{columns:{initial:"1",sm:"2",md:"3",lg:"4"},gap:"4",children:j.map(t=>e.jsxs(Ne,{className:"relative group hover:shadow-lg transition-all duration-200",children:[e.jsxs(f,{onClick:()=>{g(!0),J(t)},className:"aspect-video bg-gradient-to-br rounded-t-lg overflow-hidden relative ",children:[t.preview?e.jsx("img",{src:t.short==="default"?"/assets/edit_117847723_p0.png":`/themes/${t.short}/${t.preview}`,alt:t.name,className:"w-full h-full object-cover",onError:r=>{var n;r.currentTarget.style.display="none",(n=r.currentTarget.nextElementSibling)==null||n.classList.remove("hidden")}}):null,e.jsx(l,{align:"center",justify:"center",className:`w-full h-full ${t.preview&&t.short!=="default"?"hidden":""}`,children:e.jsx(A,{size:48,className:"text-gray-400"})}),e.jsx(f,{className:"absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity duration-200 flex items-center justify-center",children:e.jsx(l,{gap:"2"})}),t.active&&e.jsx(be,{color:"green",className:"absolute top-2 right-2 px-2 py-1 text-xs",children:s("theme.active")})]}),e.jsxs(l,{onClick:()=>{g(!0),J(t)},direction:"column",className:"p-4 space-y-2",children:[e.jsx(d,{weight:"bold",size:"3",children:t.name}),e.jsxs(l,{justify:"between",align:"center",children:[e.jsxs(d,{size:"1",color:"gray",children:["by ",t.author]}),e.jsxs(d,{size:"1",color:"gray",children:["v",t.version]})]})]}),e.jsx(l,{justify:"end",align:"center",children:!t.active&&e.jsx(ze,{size:"2",variant:"ghost",onClick:()=>C(t.short),disabled:M===t.short,children:M===t.short?e.jsx(f,{className:"animate-spin",children:e.jsx(D,{size:16})}):e.jsx(D,{size:16})})})]},t.id))}),e.jsx(ve,{open:ae,onOpenChange:U,title:s("theme.upload_theme"),description:s("theme.upload_description"),accept:".zip",dragDropText:s("theme.drag_drop"),clickToBrowseText:s("theme.or_click_to_browse"),hintText:s("theme.zip_files_only"),uploading:ee,progress:te,uploadingText:s("theme.uploading"),cancelUploadLabel:s("common.cancel"),onCancelUpload:he,onFileSelected:t=>de(t),closeLabel:s("common.cancel")}),e.jsx(O,{open:re,onOpenChange:g,children:e.jsxs(L,{maxWidth:"800px",children:[e.jsx($,{children:a==null?void 0:a.name}),e.jsxs(f,{className:"space-y-4 mt-4",children:[e.jsx(f,{className:"aspect-video bg-gray-100 dark:bg-gray-800 rounded-lg overflow-hidden relative",children:a!=null&&a.preview&&a.short!=="default"?e.jsx("img",{src:`/themes/${a.short}/${a.preview}`,alt:a.name,className:"w-full h-full object-cover"}):(a==null?void 0:a.short)==="default"?e.jsx("img",{src:"/assets/edit_117847723_p0.png",alt:a.name,className:"w-full h-full object-cover"}):e.jsx(l,{align:"center",justify:"center",className:"w-full h-full",children:e.jsx(A,{size:64,className:"text-gray-400"})})}),e.jsxs(l,{direction:"column",children:[e.jsxs(l,{gap:"2",justify:"start",align:"center",children:[e.jsx(d,{size:"2",weight:"bold",color:"gray",wrap:"nowrap",children:s("theme.author")}),e.jsx(d,{size:"3",children:a==null?void 0:a.author})]}),e.jsxs(l,{gap:"2",justify:"start",align:"center",children:[e.jsx(d,{size:"2",weight:"bold",color:"gray",wrap:"nowrap",children:s("theme.version")}),e.jsx(d,{size:"3",children:a==null?void 0:a.version})]}),e.jsxs(l,{gap:"2",justify:"start",align:"center",children:[e.jsx(d,{size:"2",weight:"bold",color:"gray",wrap:"nowrap",children:s("theme.description")}),e.jsx(d,{size:"3",children:a==null?void 0:a.description})]}),(a==null?void 0:a.url)&&e.jsxs(l,{gap:"2",justify:"start",align:"center",children:[e.jsx(d,{size:"2",weight:"bold",color:"gray",wrap:"nowrap",children:"URL"}),e.jsx(d,{size:"1",className:"overflow-hidden text-ellipsis",children:a==null?void 0:a.url}),e.jsx("a",{href:a.url,target:"_blank",children:e.jsx(_e,{size:12})})]})]})]}),e.jsxs(l,{gap:"3",mt:"4",justify:"end",children:[e.jsx(P,{children:e.jsx(u,{variant:"soft",color:"gray",children:s("common.close")})}),a&&!a.active&&e.jsx(u,{onClick:()=>{C(a.short),g(!1)},children:s("theme.set_active")}),a&&a.short!=="default"&&e.jsxs(u,{variant:"soft",color:"blue",onClick:()=>{F(a),b(!0)},className:"gap-2",children:[e.jsx(Q,{size:16}),s("theme.update")]}),a&&a.short!=="default"&&e.jsx(u,{size:"2",variant:"solid",color:"red",onClick:()=>{W(a),N(!0)},children:s("common.delete")})]})]})}),e.jsx(O,{open:ne,onOpenChange:N,children:e.jsxs(L,{maxWidth:"400px",children:[e.jsx($,{children:s("theme.confirm_delete")}),e.jsx(K,{children:s("theme.delete_warning",{themeName:w==null?void 0:w.name})}),e.jsxs(l,{gap:"3",mt:"4",justify:"end",children:[e.jsx(P,{children:e.jsx(u,{variant:"soft",color:"gray",children:s("common.cancel")})}),e.jsx(u,{color:"red",onClick:async()=>{w&&(await me(w.short),N(!1),W(null))},children:s("common.delete")})]})]})}),e.jsx(O,{open:oe,onOpenChange:b,children:e.jsxs(L,{maxWidth:"500px",children:[e.jsx($,{children:s("theme.update_theme")}),e.jsx(K,{children:s("theme.update_description")}),e.jsx(f,{className:"space-y-4 mt-4",children:e.jsx(l,{direction:"column",gap:"2",children:e.jsx(d,{size:"2",color:"gray",className:"mt-2",children:s("theme.update_mode_auto_description")})})}),e.jsxs(l,{gap:"3",mt:"4",justify:"end",children:[e.jsx(P,{children:e.jsx(u,{variant:"soft",color:"gray",children:s("common.cancel")})}),e.jsxs(u,{color:"blue",disabled:X,onClick:async()=>{B&&(await pe(B.short),b(!1),F(null))},children:[X?e.jsx(f,{className:"animate-spin mr-2",children:e.jsx(Q,{size:16})}):null,s("theme.update")]})]})]})}),e.jsxs("label",{className:"text-muted-foreground text-sm",children:[s("theme.find_more"),e.jsx("a",{href:"https://komari-document.pages.dev/community/theme.html",target:"_blank",className:"text-accent-9",children:s("theme.theme_link")})]})]})};export{Xe as default};
