import{c as re,r as j,j as e,o as ae,P as se,h as A,k as D,A as ie,R as p,u as N,b as ce,t as E}from"./entry-index-B-fzmtso.js";import{u as de}from"./chunk-require-react-element-DVojHXYL.js";import{u as le}from"./chunk-index-B-NU4fG6.js";import{c as ue}from"./chunk-index-CkaccSpC.js";import{c as fe}from"./chunk-utils-bRKmu4jq.js";import{T as he,a as me,b as F,c as y,d as pe,e as S}from"./chunk-table-CFAkpkHt.js";import{N as xe,u as z}from"./chunk-NodeDetailsContext-C405bEFp.js";import{T as be}from"./chunk-tips-CXnB5HDr.js";import{S as ge}from"./chunk-search-SRY80dSo.js";import{P as je}from"./chunk-pencil-DkFamgn6.js";import{p as P}from"./chunk-flex-MGzrVjdG.js";import{u as H,c as ve}from"./chunk-text-field-BEd1A3G3.js";import{s as q,n as $,p as G,g as J,D as Ce}from"./chunk-dialog-DmkLuhHc.js";import{o as T}from"./chunk-button-DEhGMKH8.js";import{e as ke}from"./chunk-badge-NlYxK9Bs.js";import{i as _e}from"./chunk-switch-DMZS-wzt.js";import{o as we}from"./chunk-icon-button-Bgu4ejrN.js";import"./chunk-react-vendor-Csw2ODfV.js";import"./chunk-box-3B0sA5_Q.js";import"./chunk-internal-Be4ivmVq.js";import"./chunk-base-button-DH9OSHVU.js";import"./chunk-heading-CKQb6e5J.js";/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ye=[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]],Se=re("check",ye);var Ee=["a","button","div","form","h2","h3","img","input","label","li","nav","ol","p","select","span","svg","ul"],O=Ee.reduce((n,r)=>{const i=ue(`Primitive.${r}`),d=j.forwardRef((s,t)=>{const{asChild:f,...o}=s,a=f?i:r;return typeof window<"u"&&(window[Symbol.for("radix-ui")]=!0),e.jsx(a,{...o,ref:t})});return d.displayName=`Primitive.${r}`,{...n,[r]:d}},{}),R="Checkbox",[Pe,rt]=ae(R),[Ne,I]=Pe(R);function Re(n){const{__scopeCheckbox:r,checked:i,children:d,defaultChecked:s,disabled:t,form:f,name:o,onCheckedChange:a,required:u,value:h="on",internal_do_not_use_render:l}=n,[m,v]=de({prop:i,defaultProp:s??!1,onChange:a,caller:R}),[b,C]=j.useState(null),[_,x]=j.useState(null),c=j.useRef(!1),w=b?!!f||!!b.closest("form"):!0,g={checked:m,disabled:t,setChecked:v,control:b,setControl:C,name:o,form:f,value:h,hasConsumerStoppedPropagationRef:c,required:u,defaultChecked:k(s)?!1:s,isFormControl:w,bubbleInput:_,setBubbleInput:x};return e.jsx(Ne,{scope:r,...g,children:Te(l)?l(g):d})}var K="CheckboxTrigger",U=j.forwardRef(({__scopeCheckbox:n,onKeyDown:r,onClick:i,...d},s)=>{const{control:t,value:f,disabled:o,checked:a,required:u,setControl:h,setChecked:l,hasConsumerStoppedPropagationRef:m,isFormControl:v,bubbleInput:b}=I(K,n),C=A(s,h),_=j.useRef(a);return j.useEffect(()=>{const x=t==null?void 0:t.form;if(x){const c=()=>l(_.current);return x.addEventListener("reset",c),()=>x.removeEventListener("reset",c)}},[t,l]),e.jsx(O.button,{type:"button",role:"checkbox","aria-checked":k(a)?"mixed":a,"aria-required":u,"data-state":Z(a),"data-disabled":o?"":void 0,disabled:o,value:f,...d,ref:C,onKeyDown:D(r,x=>{x.key==="Enter"&&x.preventDefault()}),onClick:D(i,x=>{l(c=>k(c)?!0:!c),b&&v&&(m.current=x.isPropagationStopped(),m.current||x.stopPropagation())})})});U.displayName=K;var X=j.forwardRef((n,r)=>{const{__scopeCheckbox:i,name:d,checked:s,defaultChecked:t,required:f,disabled:o,value:a,onCheckedChange:u,form:h,...l}=n;return e.jsx(Re,{__scopeCheckbox:i,checked:s,defaultChecked:t,disabled:o,required:f,onCheckedChange:u,name:d,form:h,value:a,internal_do_not_use_render:({isFormControl:m})=>e.jsxs(e.Fragment,{children:[e.jsx(U,{...l,ref:r,__scopeCheckbox:i}),m&&e.jsx(W,{__scopeCheckbox:i})]})})});X.displayName=R;var V="CheckboxIndicator",Y=j.forwardRef((n,r)=>{const{__scopeCheckbox:i,forceMount:d,...s}=n,t=I(V,i);return e.jsx(se,{present:d||k(t.checked)||t.checked===!0,children:e.jsx(O.span,{"data-state":Z(t.checked),"data-disabled":t.disabled?"":void 0,...s,ref:r,style:{pointerEvents:"none",...n.style}})})});Y.displayName=V;var Q="CheckboxBubbleInput",W=j.forwardRef(({__scopeCheckbox:n,...r},i)=>{const{control:d,hasConsumerStoppedPropagationRef:s,checked:t,defaultChecked:f,required:o,disabled:a,name:u,value:h,form:l,bubbleInput:m,setBubbleInput:v}=I(Q,n),b=A(i,v),C=le(t),_=ie(d);j.useEffect(()=>{const c=m;if(!c)return;const w=window.HTMLInputElement.prototype,B=Object.getOwnPropertyDescriptor(w,"checked").set,ne=!s.current;if(C!==t&&B){const oe=new Event("click",{bubbles:ne});c.indeterminate=k(t),B.call(c,k(t)?!1:t),c.dispatchEvent(oe)}},[m,C,t,s]);const x=j.useRef(k(t)?!1:t);return e.jsx(O.input,{type:"checkbox","aria-hidden":!0,defaultChecked:f??x.current,required:o,disabled:a,name:u,value:h,form:l,...r,tabIndex:-1,ref:b,style:{...r.style,..._,position:"absolute",pointerEvents:"none",opacity:0,margin:0,transform:"translateX(-100%)"}})});W.displayName=Q;function Te(n){return typeof n=="function"}function k(n){return n==="indeterminate"}function Z(n){return k(n)?"indeterminate":n?"checked":"unchecked"}function M({className:n,...r}){return e.jsx(X,{"data-slot":"checkbox",className:fe("peer border-[var(--accent-6)] bg-[var(--accent-1)] data-[state=checked]:bg-[var(--accent-8)] data-[state=checked]:text-[var(--accent-12)] data-[state=checked]:border-[var(--accent-9)] focus-visible:border-[var(--accent-10)] focus-visible:ring-[var(--accent-7)]/50 aria-invalid:ring-red-500/20 dark:aria-invalid:ring-red-400/40 aria-invalid:border-red-500 size-4 shrink-0 rounded-[4px] border shadow-xs transition-shadow outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50",n),...r,children:e.jsx(Y,{"data-slot":"checkbox-indicator",className:"flex items-center justify-center text-current transition-none",children:e.jsx(Se,{className:"size-3.5"})})})}const ee=p.createContext(void 0),Oe=({children:n})=>{const[r,i]=p.useState([]),[d,s]=p.useState(!1),t=p.useRef(!0),[f,o]=p.useState(null),a=async()=>{t.current&&s(!0);try{const u=await fetch("/api/admin/notification/offline");if(!u.ok)throw new Error("Failed to fetch offline notifications");const h=await u.json();i(h.data||[])}catch(u){console.error("Error fetching offline notifications:",u),o(u instanceof Error?u:new Error(String(u)))}finally{t.current&&(s(!1),t.current=!1)}};return p.useEffect(()=>{a()},[]),e.jsx(ee.Provider,{value:{offlineNotification:r,refresh:a,loading:d,error:f},children:n})},L=()=>{const n=p.useContext(ee);if(!n)throw new Error("useOfflineNotification must be used within a OfflineNotificationProvider");return n},at=()=>e.jsx(Oe,{children:e.jsx(xe,{children:e.jsx(Ie,{})})}),te=({initialValues:n,onSubmit:r,loading:i,onCancel:d})=>{const{t:s}=N(),[t,f]=p.useState(n.enable),[o,a]=p.useState(n.grace_period);return e.jsxs("form",{onSubmit:u=>{u.preventDefault(),r({enable:t,cooldown:3e3,grace_period:o})},className:"flex flex-col gap-2",children:[e.jsx("label",{htmlFor:"status",children:s("common.status")}),e.jsx(_e,{id:"status",name:"status",checked:t,onCheckedChange:f}),e.jsxs("label",{htmlFor:"grace_period",className:"flex items-center gap-2",children:[s("notification.offline.grace_period"),e.jsx(be,{children:s("notification.offline.grace_period_tip")})]}),e.jsx(H,{type:"number",min:0,value:o,onChange:u=>a(Number(u.target.value)),id:"grace_period",name:"grace_period"}),e.jsxs(P,{gap:"2",justify:"end",className:"mt-4",children:[d&&e.jsx(Ce,{children:e.jsx(T,{variant:"soft",color:"gray",type:"button",onClick:d,children:s("common.cancel")})}),e.jsx(T,{variant:"solid",type:"submit",disabled:i,children:s("common.save")})]})]})},Ie=()=>{const[n,r]=p.useState(""),[i,d]=p.useState([]),{loading:s,error:t,offlineNotification:f,refresh:o}=L(),{isLoading:a,error:u}=z(),{t:h}=N(),[l,m]=p.useState(!1),[v,b]=p.useState(!1),[C,_]=p.useState({enable:!0,cooldown:1800,grace_period:300}),x=c=>{m(!0);const w=i.map(g=>({client:g,enable:c.enable,cooldown:c.cooldown,grace_period:c.grace_period}));fetch("/api/admin/notification/offline/edit",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(w)}).then(g=>(g.ok?E.success(h("common.updated_successfully")):E.error("Failed to update offline notifications: "+g.statusText),g.json())).then(()=>{m(!1),b(!1),o()}).catch(g=>{console.error("Error updating offline notifications:",g),E.error(h("common.error",{message:g.message})),m(!1)})};return s||a?e.jsx(ce,{text:"(o゜▽゜)o☆"}):t||u?e.jsxs("div",{children:["Error: ",(t==null?void 0:t.message)||u]}):e.jsxs("div",{className:"flex flex-col gap-4 md:p-4 p-1",children:[e.jsxs(P,{justify:"between",align:"center",wrap:"wrap",children:[e.jsx("label",{className:"text-2xl font-semibold",children:h("notification.offline.full_title","离线通知设置")}),e.jsx(H,{type:"text",className:"max-w-64",placeholder:h("common.search"),value:n,onChange:c=>r(c.target.value),children:e.jsx(ve,{children:e.jsx(ge,{size:16})})})]}),e.jsx(Le,{search:n,selected:i,onSelectionChange:d}),e.jsx("label",{className:"text-sm text-muted-foreground",children:h("common.selected",{count:i.length})}),e.jsx(P,{gap:"2",align:"center",children:e.jsxs(q,{open:v,onOpenChange:b,children:[e.jsx($,{children:e.jsx(T,{variant:"soft",onClick:()=>{const c=f.find(w=>w.client===i[0]);_({enable:(c==null?void 0:c.enable)??!0,cooldown:(c==null?void 0:c.cooldown)??1800,grace_period:(c==null?void 0:c.grace_period)??300})},disabled:l||i.length===0,children:h("notification.offline.batch_edit")})}),e.jsxs(G,{children:[e.jsx(J,{children:h("notification.offline.batch_edit")}),e.jsx(te,{initialValues:C,loading:l,onSubmit:x,onCancel:()=>b(!1)})]})]})}),e.jsx("label",{className:"text-sm text-muted-foreground",children:e.jsx("span",{dangerouslySetInnerHTML:{__html:h("notification.offline.tips")}})})]})},Le=({search:n,selected:r,onSelectionChange:i})=>{const{offlineNotification:d}=L(),{nodeDetail:s}=z(),{t}=N(),f=[...s].sort((o,a)=>o.weight-a.weight).filter(o=>o.name.toLowerCase().includes(n.toLowerCase()));return e.jsx("div",{className:"rounded-lg overflow-hidden",children:e.jsxs(he,{children:[e.jsx(me,{children:e.jsxs(F,{children:[e.jsx(y,{className:"w-6",children:e.jsx(M,{checked:r.length===f.length?!0:r.length>0?"indeterminate":!1,onCheckedChange:o=>i(o?f.map(a=>a.uuid):[])})}),e.jsx(y,{children:t("common.server")}),e.jsx(y,{children:t("common.status")}),e.jsx(y,{children:t("notification.offline.grace_period")}),e.jsx(y,{children:t("notification.offline.last_notified")}),e.jsx(y,{children:t("common.action")})]})}),e.jsx(pe,{children:f.map(o=>{var a,u,h;return e.jsxs(F,{children:[e.jsx(S,{children:e.jsx(M,{checked:r.includes(o.uuid),onCheckedChange:l=>{i(l?[...r,o.uuid]:r.filter(m=>m!==o.uuid))}})}),e.jsx(S,{children:o.name}),e.jsx(S,{children:e.jsx(ke,{color:(a=d.find(l=>l.client===o.uuid))!=null&&a.enable?"green":"red",children:(u=d.find(l=>l.client===o.uuid))!=null&&u.enable?t("common.enabled"):t("common.disabled")})}),e.jsxs(S,{children:[((h=d.find(l=>l.client===o.uuid))==null?void 0:h.grace_period)||300,t("nodeCard.time_second")]}),e.jsx(S,{children:(()=>{var v;const l=(v=d.find(b=>b.client===o.uuid))==null?void 0:v.last_notified;if(!l)return"-";const m=new Date(l);return m.getFullYear()<3?t("notification.offline.never_triggered"):m.toLocaleString()})()}),e.jsx(S,{children:e.jsx(Be,{offlineNotifications:d.find(l=>l.client===o.uuid)})})]},o.uuid)})})]})})},Be=({offlineNotifications:n})=>{const{t:r}=N(),{refresh:i}=L(),[d,s]=p.useState(!1),[t,f]=p.useState(!1);return e.jsx(P,{gap:"2",align:"center",children:e.jsxs(q,{open:d,onOpenChange:s,children:[e.jsx($,{children:e.jsx(we,{variant:"ghost",children:e.jsx(je,{size:16})})}),e.jsxs(G,{children:[e.jsx(J,{children:r("common.edit")}),e.jsx(te,{initialValues:{enable:(n==null?void 0:n.enable)??!1,cooldown:(n==null?void 0:n.cooldown)??1800,grace_period:(n==null?void 0:n.grace_period)??300},loading:t,onSubmit:o=>{f(!0),fetch("/api/admin/notification/offline/edit",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify([{client:n==null?void 0:n.client,...o}])}).then(a=>(a.ok||E.error("Failed to save offline notification settings: "+a.statusText),E.success(r("common.updated_successfully")),a.json())).then(()=>{s(!1),i(),f(!1)}).catch(a=>{console.error("Error saving offline notification settings:",a),E.error(r("common.error",{message:a.message}))})},onCancel:()=>s(!1)})]})]})})};export{at as default};
